<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/pensive.css">
<!--    style csss-->
    <link rel="stylesheet" href="css/single.css">
<!--    font awesome cdn-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <title>Blog</title>
</head>
<body>
<!--navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <a class='navbar-brand' href='/'>
        <i aria-hidden="true"></i>
        Portfolio</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a aria-disabled='true' class='nav-link btn btn-primary text-light' href='/blog'>Blogs</a>
            </li>
        </ul>
    </div>
</nav>
<!--end navbar-->

<!--first-section-->
<div class="first-section">
    <div class="container" >
        <div class="row justify-content-center">
            <div id="blogpost" class="blog ">
                <div id="blog"><h1 id="title" >4 Tips for Writing Awesome Blog Titles</h1>
                <div class="user d-flex align-items-start justify-content-between bg-light p-4 rounded">
                    <div class="d-flex align-items-start">
                        <img src="./assets/img/kajal.png" class="img-fluid rounded-circle" alt="">
                        <div class="d-block">
                            <span class="d-block">by <a class="h6" href="#">Admin</a></span>
                            <span class="d-block text-muted">17th March</span>
                        </div>
                    </div>
                    <span id="view" class="badge badge-light-primary"><i class="fa fa-eye" aria-hidden="true"></i>1</span>
                    <span id="heart"  class="badge badge-light-primary"><i class="fa fa-heart" aria-hidden="true"></i>1</span>
                    <span id="comment" class="badge badge-light-primary"><i class="fa fa-comment" aria-hidden="true"></i>4</span>
                
                </div>
                <!--//blog section-->
                <div class="blog-section">
                    <img src="./assets/img/blog1.png" class="bounce-little img-fluid shadow-sm rounded " alt="">
                    <p class="lead mt-3"></p>
                    <p></p>
                    
                </div>
              </div>
                <!--share section-->
                <hr>
                <div  class="share text-center d-flex align-items-center justify-content-center">
                    <button onclick="likePost()" id="wen" type="button" class="btn btn-primary btn-sm">Like</button>
                    <span class="mr-3">Share this article:</span>
                    <i class="fa fa-facebook-square text-primary" aria-hidden="true"></i>
                    <i class="fa fa-google-plus text-primary" aria-hidden="true"></i>
                    <i class="fa fa-github text-primary"  aria-hidden="true"></i>
                </div>
                <hr>

                <!--comments section-->
                <div id="comment-container" class="comment-section">
                    <h4>4 Comments</h4>
                    <div id="commentCard" class="media">
                        <img src="./assets/img/person/person2.png" class="mr-3 rounded-circle" alt="...">
                        <div class="media-body">
                            <h6 class="mt-0">John Doe <span class="text-muted small">18 Minutes ago.</span></h6>

                            Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis. Fusce condimentum nunc ac nisi vulputate fringilla. Donec lacinia congue felis in faucibus.
                        </div>
                        <div class="reply">
                            <a  href="#">Reply</a>
                        </div>
                    </div>

                    <div class="media">
                        <img src="./assets/img/person/person6.png" class="mr-3 rounded-circle" alt="...">
                        <div class="media-body">
                            <h6 class="mt-0">Kajal Aaggrwal <span class="text-muted small">18 Minutes ago.</span></h6>

                            Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis. Fusce condimentum nunc ac nisi vulputate fringilla. Donec lacinia congue felis in faucibus.
                        </div>
                        <div class="reply">
                            <a  href="#">Reply</a>
                        </div>
                    </div>
                    <div  class="media">
                        <img src="./assets/img/person/person4.png" class="mr-3 rounded-circle" alt="...">
                        <div class="media-body">
                            <h6 class="mt-0">Nancy <span class="text-muted small">18 Minutes ago.</span></h6>

                            Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis. Fusce condimentum nunc ac nisi vulputate fringilla. Donec lacinia congue felis in faucibus.
                        </div>
                        <div class="reply">
                            <a  href="#">Reply</a>
                        </div>
                    </div>
                    <hr>
                    <div  class="post-comment">
                        <h1 class="h2">Post a comment</h1>
                        <form id="comment-form">
                            <div  class="form-row">
                                
                                <div class="col">
                                    <input type="text" id="email" class="form-control" placeholder="Email Address">
                                </div>
                            </div>
                            <div  class="form-group mt-3">
                                <textarea id="blog-comment" class="form-control" cols="10" rows="5" placeholder="Comment here."></textarea>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-primary">Post</button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<!--end first-section-->

<!--footer-section-->
<div class="py-4 text-center bg-warning mt-5">
    <p class="m-0">Â© Copyright 2024 Portfolio. All rights reserved.</p>
</div>
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

<script>
    async function showBlog(){
      const blogHeader = document.getElementById("blogpost");
const blogContent = document.getElementById('single-blogcontent');
let currentUrl = window.location.href;
let indexUrl = currentUrl.split('index=')[1];
console.log(indexUrl);

fetch(`https://portfolio-backend-jpr9.onrender.com/blogs/${indexUrl}`)
  .then(response => response.json()) // Corrected to use 'response' instead of 'data'
  .then(blog => {
    showBlogs(blog); // Moved showBlogs function call here

    function showBlogs(blog) { // Defined showBlogs function here
      console.log(blog);
      const blogpost=document.getElementById("blog");
      console.log(blogpost);
      blogpost.innerHTML=`
      <div id="blog"><h1 id="title" >${blog.title}</h1>
                <div class="user d-flex align-items-start justify-content-between bg-light p-4 rounded">
                    <div class="d-flex align-items-start">
                        <img src="./assets/img/kajal.png" class="img-fluid rounded-circle" alt="">
                        <div class="d-block">
                            <span class="d-block">by <a class="h6" href="#">Admin</a></span>
                            <span class="d-block text-muted">${blog.timecreated.split("T")[0]}</span>
                        </div>
                    </div>
                    <button id="view" class="badge badge-light-primary"><i class="fa fa-eye" aria-hidden="true"></i>${blog.views}</button>
                    <button onclick(console.log) id="heart" class="badge badge-light-primary"><i class="fa fa-heart" aria-hidden="true"></i>${blog.likes}</button>
                    <button id="comment" class="badge badge-light-primary"><i class="fa fa-comment" aria-hidden="true"></i>${blog.comments.length}</button>
                
                </div>
                <!--//blog section-->
                <div class="blog-section">
                    <img src="${blog.image}" class="bounce-little img-fluid shadow-sm rounded " alt="">
                    <p class="lead mt-3">${blog.subtitle}</p>
                    <p>${blog.content.split("\n").map((paragraph) => paragraph).join("<br>")}</p>
                    
                </div>
              </div>
      `;
    }
  })
  .catch(error => {
    console.error('Error fetching data:', error);
  });

//     blogHeader.innerHTML = `
//     <div class="rounded-text white-text category-tag"><p>${blog.category}</p></div>
// <div><h3 class="big-text">${blog.title}</h3></div>
// <div><p class="grey-text text-center join-text">${blog.subtitle}</p></div>
// <div class="blog-dates">
//   <div class="date blog-dates-details">
//       <span class="material-symbols-outlined">
//           calendar_today
//           </span>
//           <p>${(blog.createdAt.split("T")[0]).split("-").join("/")}</p>
//   </div>
//   <div class="date blog-dates-details">
//       <span class="material-symbols-outlined">
//           timer
//           </span>
//           <p>${blog.timeToRead } Minutes</p>
//   </div>
// </div>
//     `

//     blogContent.innerHTML = `
// <div class="single-blog-content" id="single-blog-content">
//   <img src="${blog.poster}" alt="" class="blog-image blog-image-poster">

//   <div class="blog-content">
//     <p class="white-text">${blog.content.split("\n").map((paragraph) => paragraph).join("<br>")}</p>
//     <!-- Use .join("<br>") to replace newlines with <br> tags -->
//   </div>

//   <div class="blog-home-card-info blog-likes-section">
   
//   </div>

//        <div class="blog-home-card-info">
//     <img src="../assets/images/my-avatar.svg" alt="" class="avatar">
//     <p class="grey-text">${blog.editor || "Angelo Christian"}</p>
//     <p class="grey-text">&#x2022;</p>
//     <p class="grey-text">${blog.createdAt.split("T")[0]}</p>
//   </div>

//   <div class="blog-comment-section">
//     <p class="white-text title">Comments</p>
//     <form action="" class="input-for comment-form" id="comment-form">
//       <input type="text" name="comment" id="blog-comment" placeholder="Comment here"/>
//       <button type="submit" class="rounded-text category-tag white-text title" >Add comment</button>
//     </form>

//     <div class="comment-container" id="comment-container">
      
//     </div>
//   </div>
// </div>
// `;


// fetch(`https://portfolio-backend-jpr9.onrender.com/${indexUrl}/like`)
//   .then(response => response.json())
//   .then(data => {
//     setLikeData(data.likes);
//   })
//   .catch(error => {
//     console.error('Error fetching data:', error);
//   });

// function setLikeData(data) {
//   likesContainer.innerHTML = `
//     <span id="like" class="badge badge-light-primary"><i class="fa fa-heart" aria-hidden="true"></i>${data.like}</span>
//   `;

//   initializeLikeButton(data, heartButton);

//   heartButton.addEventListener("click", () => {
//     handleLikes();
//   });
// }

// const handleLikes = () => {
//   const params = {
//     userId: loggedUser?._id,
//     blogId: indexUrl,
//     isLiked: true
//   };

//   fetch(`https://portfolio-backend-jpr9.onrender.com/${indexUrl}/like`, {
//     method: 'POST',
//     body: JSON.stringify(params),
//     headers: {
//       "Authorization": `Bearer ${tokens.bearerToken}`,
//       'Content-Type': 'application/json',
//     }
//   })
//     .then(response => response.json())
//     .then(data => {
//       successContainer.style.display = "flex";
//       successElement.innerHTML = data.message;
//       timeDelay(successContainer, successElement);
//       setTimeout(() => {
//         window.location.reload();
//       }, 2000);
//       return data;
//     })
//     .catch(error => {
//       console.error('Error:', error);
//       // Handle error here
//     });
// };

// // // Add event listener to the heart icon
// // heart.addEventListener('click', handleLikeBlog);

// function initializeLikeButton(data, heart) {
// const userLiked = data.some((like) => like.userId === loggedUser?._id);

// if (userLiked) {
//   heart.src = "../assets/images/favorite.svg";
//   heart.alt = 'liked';
// } else {
//   heart.src = "../assets/images/favorite-outline.svg";
//   heart.alt = 'not-liked';
// }
// }

// function handleLikeBlog(data) {
// const likeExists = data.find((like) => like.userId === loggedUser?._id);

// if (likeExists) {
//   // User unlikes the post
//   heart.src = "../assets/images/favorite-outline.svg";
//   heart.alt = 'not-liked';

//   handleLikes()

// } else {
//   handleLikes()
//   heart.src = "../assets/images/favorite.svg";
//   heart.alt = 'liked';
  
// }
// // allBlogs[indexUrl].likes = storageLikes
// // console.log("this blog index url", allBlogs[indexUrl])
// // Update the like count (you can display it wherever needed)
// // const likeCount = storageLikes.length;
// // console.log(`Total likes: ${likeCount}`);

// // localStorage.setItem('articles', JSON.stringify(allBlogs))
// successContainer.style.display = "flex",
//       successElement.innerHTML = "Liked updated"
//       timeDelay(successContainer, successElement)
//       setTimeout(()=>{
//          window.location.reload();
//       }, 2000)
     
//   }
const blogComment = document.getElementById('blog-comment');
const commentForm = document.getElementById('comment-form');
const commentContainer = document.getElementById('comment-container');

commentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (blogComment.value === '' || blogComment.value == null) {
        errorContainer.style.display = "flex";
        errorElement.innerHTML = "Please input comment";
        timeDelay(errorContainer, errorElement);
    } else {
        await submitComment();
    }
});

const handleAddComment = () => {
    const loggedUser = localStorage.getItem("currentUserEmail");
    const today = new Date().getDate();
    const month = new Date().getMonth() + 1;
    const year = new Date().getFullYear();
    const hours = new Date().getHours();
    const minutes = new Date().getMinutes();
    const seconds = new Date().getSeconds();

    const params = {
        postedBy: loggedUser,
        date: `${today}/${month}/${year}`,
        time: `${hours}:${minutes}:${seconds}`,
        content: blogComment.value,
    };

    blog.comments.push(params);

    setTimeout(() => {
        window.location.reload();
    }, 2000);
};

try {
    const response = await fetch(`https://portfolio-backend-jpr9.onrender.com/blogs/${indexUrl}`);
    if (!response.ok) {
        throw new Error('Failed to fetch comments');
    
    const data = await response.json();
    console.log("-------------comment data", data);
     const storageComments=data;

const populateComments = async (storageComments) => {
    if (!Array.isArray(storageComments) || storageComments.length === 0) {
        commentContainer.innerHTML = `
            <div class="upper-text">
                <p class="white-text title small-text">No Comments Yet</p>
                <p class="grey-text small-text"></p>
            </div>
            <p class="small-text grey-text comment-text">Be the first to comment</p>
        `;
        return;
    }

    const userIds = storageComments.map(comment => comment.userId);
    const userResponses = await Promise.all(userIds.map(userId =>
        fetch(`https://portfolio-backend-jpr9.onrender.com/users/${userId}`, {
            headers: {
                "Authorization": `Bearer ${tokens.bearerToken}`,
                'Content-Type': 'application/json',
            },
            method: "GET"
        })
        .then(response => response.json())
        .catch(error => console.error("Error fetching data:", error))
    ));

    userResponses.forEach((userData, index) => {
        const commentCard = document.createElement('div');
        commentCard.className = "media";

        const comment = storageComments[index];
        const commentDate = new Date(comment.timestamp);

        commentCard.innerHTML = `
            <img src="./assets/img/person/person2.png" class="mr-3 rounded-circle" alt="...">
            <div class="media-body">
                <h6 class="mt-0">${userData.username}<span class="text-muted small">${commentDate.toLocaleString()}</span></h6>
                ${comment.comment}
            </div>
            <div class="reply">
                <a href="#">Reply</a>
            </div>
        `;

        commentContainer.appendChild(commentCard);
    });
};

const submitComment = async () => {
    const email = document.getElementById("email"); // Assuming you have an element with id "email"
    const params = {
        email: email.value, // Assuming "email" is the email of the commenter
        comment: blogComment.value
    };}}
} catch (error) {
    console.error('Comment Error:', error);
}


    try {
        const params = {
        email: email.value, // Assuming "email" is the email of the commenter
        comment: blogComment.value
    }
        const tokens = localStorage.getItem("token");

        const response = await fetch(`https://portfolio-backend-jpr9.onrender.com/${indexUrl}/comment`, {
            method: 'POST',
            body: JSON.stringify(params),
            headers: {
                "Authorization": `Bearer ${tokens.bearerToken}`,
                'Content-Type': 'application/json',
            }
        });
        if (!response.ok) {
            throw new Error('Failed to submit comment');
        }
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    } catch (error) {
        console.error('Error:', error);
    }
};
    
showBlog();

const likePost = async () => {
    try {
        let currentUrl = window.location.href;
        let indexUrl = currentUrl.split('index=')[1];
        const email = localStorage.getItem('currentUserEmail');
        const token = localStorage.getItem("token");

        const headers = new Headers();
        headers.append("Authorization", `Bearer ${token}`);
        headers.append('Content-Type', 'application/json');

        const response = await fetch(`https://portfolio-backend-jpr9.onrender.com/${indexUrl}/like`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ email, postId: indexUrl })
        });

        const data = await response.json();
        console.log("Liked!!!!");
        
        console.log(data);
        return data;
        
    } catch (error) {
        console.error('Error:', error);
        throw new Error('Failed to like post');
    }
    
};

const heartSpan = document.getElementById("heart");
const currentUser = localStorage.getItem('currentUserEmail');

// Add an event listener for the 'click' event
window.onload = function () {
    if (!currentUser) {
        window.location.href = "login.html";


}}

  </script>
</body>

</html>
